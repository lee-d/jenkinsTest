@NonCPS
def getVulnerabilityReport() {
    def analysis = new XmlSlurper().parse("${workspace}/target/dependency-check-report.xml")

    def highSeverityMap = [:]
    def highestSeverityMap = [:]
    def normalSeverityMap = [:]
    def dependencyCheckMap = [:]
    def blaMap = [:]
    def highSeverityCount = 0
    def highestSeverityCount = 0
    def normalSeverityCount = 0
    def desc = ""
    def projectName = analysis.projectInfo.artifactID.text()

    analysis.dependencies.dependency.each {
       highSeverityCount = highSeverityCount + it.vulnerabilities.vulnerability.count {
          it.severity.text().toLowerCase().equals('high')
       }
       highestSeverityCount = highestSeverityCount + it.vulnerabilities.vulnerability.count {
         it.severity.text().toLowerCase().equals('highest')
       }

       it.vulnerabilities.vulnerability.each {
          if (it.severity.text().toLowerCase().equals('medium')) {
            normalSeverityCount++
          }
       }

       it.vulnerabilities.vulnerability.each {
                         desc + it.severity.text()
                       }

       highSeverityMap[projectName] = highSeverityCount
       highestSeverityMap[projectName] = highestSeverityCount
       normalSeverityMap[projectName] = normalSeverityCount
    }
    blaMap[projectName] = desc

    dependencyCheckMap['high-severity'] = highSeverityMap
    dependencyCheckMap['highest-severity'] = highestSeverityMap
    dependencyCheckMap['normal-severity'] = normalSeverityMap
    dependencyCheckMap['test'] = blaMap
    return dependencyCheckMap
}

pipeline {
    agent any
    triggers {
        pollSCM 'H/5 * * * *'
        cron 'H H(0-5) * * *'
    }
    environment {
        SERVICE = 'foo'
    }
    stages {
        stage('Maven Build') {
            steps {
                sh "mvn -B clean verify -DskipTests"
                archiveArtifacts artifacts: 'target/*.jar'
                dependencyCheckPublisher pattern: 'target/dependency-check-report.*'

                script {
                    def result = getVulnerabilityReport()
                    step([$class: 'InfluxDbPublisher', target: 'grafana', customPrefix: null, customDataMap: result])
                }
            }
        }
    }
}
