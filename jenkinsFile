@NonCPS
def getVulnerabilityReport() {

    // Write stuff to InfluxDB
    // NOTE! If you have more targets configured in Jenkins, it's safer to add "selectedTarget" parameter to the InfluxDB step to ensure
    // data is sent to the correct target.
    // step([$class: 'InfluxDbPublisher', target: 'myNewTarget', selectedTarget: 'myNewTarget', customPrefix: 'myPrefix', customData: myDataMap])

    // Remove a target by using the target description field value

    def analysis = new XmlSlurper().parse("${workspace}/target/dependency-check-report.xml")
    def projectName = analysis.projectInfo.artifactID.text()

    def dependencyCheckMap = [:]
    def highestSeverityMap = [:]
    def highSeverityMap = [:]
    def normalSeverityMap = [:]
    def highestSeverityCount = 0
    def highSeverityCount = 0
    def normalSeverityCount = 0

    analysis.dependencies.dependency.each {
       highestSeverityCount = highestSeverityCount + it.vulnerabilities.vulnerability.count {
         it.severity.text().toLowerCase().equals('highest')
       }
       highSeverityCount = highSeverityCount + it.vulnerabilities.vulnerability.count {
          it.severity.text().toLowerCase().equals('high')
       }
       normalSeverityCount = normalSeverityCount + it.vulnerabilities.vulnerability.count {
        it.severity.text().toLowerCase().equals('medium')
      }

       highSeverityMap[projectName] = highSeverityCount
       highestSeverityMap[projectName] = highestSeverityCount
       normalSeverityMap[projectName] = normalSeverityCount
    }

    dependencyCheckMap['high-severity'] = highSeverityMap
    dependencyCheckMap['highest-severity'] = highestSeverityMap
    dependencyCheckMap['normal-severity'] = normalSeverityMap
    return dependencyCheckMap

    def result = getVulnerabilityReport()
    step([$class: 'InfluxDbPublisher', target: 'grafana', selectedTarget: 'grafana', customPrefix: null, customDataMap: result])
}

pipeline {
    agent any
    triggers {
        pollSCM 'H/5 * * * *'
        cron 'H H(0-5) * * *'
    }
    environment {
        SERVICE = 'foo'
    }
    stages {
        stage('Maven Build') {
            steps {
                sh "mvn -B clean verify -DskipTests"
                archiveArtifacts artifacts: 'target/*.jar'
                dependencyCheckPublisher pattern: 'target/dependency-check-report.*'
                getVulnerabilityReport()
            }
        }
    }
}
